{% extends "base.html" %}

{% block title %}Sentinel | Dashboard Overview{% endblock %}
{% block breadcrumb %}Dashboard Overview{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-slate-900 mb-2">Dashboard</h1>
    <p class="text-slate-500">Real-time fraud detection insights and analytics</p>
</div>

<!-- Filters -->
<div class="flex gap-6 mb-8 items-center bg-white p-4 rounded-xl shadow-sm border border-slate-200">
    <div class="flex items-center gap-3">
        <span class="text-sm font-semibold text-slate-700">Category:</span>
        <div class="flex items-center justify-between border rounded-lg px-4 py-2 w-64 bg-slate-50 cursor-pointer">
            <span class="text-sm text-slate-600">All Categories</span>
            <i data-lucide="chevron-down" class="h-4 w-4 text-slate-400"></i>
        </div>
    </div>

    <div class="flex items-center gap-3">
        <span class="text-sm font-semibold text-slate-700">Date Range:</span>
        <div class="flex items-center gap-3 border rounded-lg px-4 py-2 bg-slate-50 cursor-pointer">
            <span class="text-sm text-slate-600">2026-02-18 &rarr; 2026-03-18</span>
            <i data-lucide="calendar" class="h-4 w-4 text-slate-400"></i>
        </div>
    </div>
</div>

<!-- Stats Grid -->
<div class="grid grid-cols-4 gap-6 mb-8">
    <!-- Card 1 -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-between">
        <p class="text-sm font-medium text-slate-500 mb-4">Total Scanned</p>
        <div class="flex items-center gap-4">
            <div class="bg-blue-50 p-3 rounded-lg">
                <i data-lucide="activity" class="h-8 w-8 text-blue-500"></i>
            </div>
            <div>
                <h2 class="text-3xl font-bold text-slate-900" id="stat_total_scanned">{{ stats.total_scanned }}</h2>
                <p class="text-xs text-blue-500 font-medium mt-1">Live Processing</p>
            </div>
        </div>
    </div>

    <!-- Card 2 -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-between">
        <p class="text-sm font-medium text-slate-500 mb-4">ISO 20022 Messages</p>
        <div class="flex items-center gap-4">
            <div class="bg-indigo-50 p-3 rounded-lg">
                <i data-lucide="file-json" class="h-8 w-8 text-indigo-400"></i>
            </div>
            <div>
                <h2 class="text-3xl font-bold text-slate-900">{{ stats.iso_messages }}</h2>
                <p class="text-xs text-blue-500 font-medium mt-1">Parsed & Stored</p>
            </div>
        </div>
    </div>

    <!-- Card 3 -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-between">
        <p class="text-sm font-medium text-slate-500 mb-4">High Risk Alerts</p>
        <div class="flex items-center gap-4">
            <div class="bg-rose-50 p-3 rounded-lg">
                <i data-lucide="bell-ring" class="h-8 w-8 text-rose-500"></i>
            </div>
            <div>
                <h2 class="text-3xl font-bold text-rose-600">{{ stats.high_risk }}</h2>
                <p class="text-xs text-rose-500 font-medium mt-1">Needs Attention</p>
            </div>
        </div>
    </div>

    <!-- Card 4 -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-between">
        <p class="text-sm font-medium text-slate-500 mb-4">Pending Review</p>
        <div class="flex items-center gap-4">
            <div class="bg-amber-50 p-3 rounded-lg">
                <i data-lucide="clock" class="h-8 w-8 text-amber-500"></i>
            </div>
            <div>
                <h2 class="text-3xl font-bold text-amber-600">{{ stats.pending_review }}</h2>
                <p class="text-xs text-amber-500 font-medium mt-1">Awaiting Action</p>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Alerts Panel -->
<div class="bg-white border border-slate-200 rounded-xl shadow-sm p-6 min-h-[400px]">
    <div class="flex justify-between items-center mb-6">
        <h3 class="font-semibold text-slate-900 flex items-center gap-2">
            Security Events
            <span class="relative flex h-3 w-3 inline-block ml-2">
                <span
                    class="animate-ping absolute inline-flex h-full w-full rounded-full bg-rose-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-rose-500"></span>
            </span>
        </h3>
        <button onclick="triggerSimulate()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors focus:ring-4 focus:ring-blue-100 flex items-center gap-2">
            <i data-lucide="play" class="h-4 w-4"></i> Simulate Transaction
        </button>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse" id="alertsTable">
            <thead>
                <tr class="border-b border-slate-200">
                    <th class="py-3 px-4 text-xs font-semibold text-slate-500 uppercase">Time</th>
                    <th class="py-3 px-4 text-xs font-semibold text-slate-500 uppercase">Alert Type</th>
                    <th class="py-3 px-4 text-xs font-semibold text-slate-500 uppercase">Risk Score</th>
                    <th class="py-3 px-4 text-xs font-semibold text-slate-500 uppercase">Description</th>
                </tr>
            </thead>
            <tbody class="text-sm divide-y divide-slate-100">
                <!-- Alerts will be injected here -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function triggerSimulate() {
        fetch('/api/simulate', { method: 'POST' })
            .then(res => res.json())
            .then(data => console.log("Mock Transaction Triggered", data))
            .catch(err => console.error("Error triggering mock transaction", err));
    }

    socket.on('new_fraud_alert', function (data) {
        console.log('Received Alert:', data);

        let totalScannedElem = document.getElementById("stat_total_scanned");
        if (totalScannedElem) {
            let current = parseInt(totalScannedElem.innerText.replace(/,/g, '')) || 0;
            totalScannedElem.innerText = (current + 1).toLocaleString();
        }

        const tbody = document.querySelector('#alertsTable tbody');
        const row = document.createElement('tr');

        const isBlocked = data.status === 'BLOCKED';
        row.className = `transition-colors duration-1000 ${isBlocked ? 'bg-rose-50' : 'bg-blue-50'}`;

        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2, '0') + ":" +
            now.getMinutes().toString().padStart(2, '0') + ":" +
            now.getSeconds().toString().padStart(2, '0');

        row.innerHTML = `
            <td class="py-3 px-4 whitespace-nowrap text-slate-500 font-mono text-xs">${timeStr}</td>
            <td class="py-3 px-4 font-semibold ${isBlocked ? 'text-rose-600' : 'text-blue-600'}">
                <div class="flex items-center gap-2">
                    <i data-lucide="${isBlocked ? 'alert-triangle' : 'info'}" class="h-4 w-4"></i>
                    ${data.type}
                </div>
            </td>
            <td class="py-3 px-4">
                <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium ${isBlocked ? 'bg-rose-100 text-rose-800' : 'bg-blue-100 text-blue-800'}">
                    ${data.score || 0}
                </span>
            </td>
            <td class="py-3 px-4 text-slate-600">
                <span class="font-mono text-xs text-slate-400 mr-2">[${data.tx_id}]</span>
                ${data.desc}
            </td>
        `;

        tbody.insertBefore(row, tbody.firstChild);
        lucide.createIcons(); // render icons inside the new row

        setTimeout(() => { row.className = "transition-colors duration-1000 hover:bg-slate-50"; }, 2000);

        if (tbody.children.length > 20) { tbody.removeChild(tbody.lastChild); }
    });
</script>
{% endblock %}