{% extends "base.html" %}

{% block title %}Sentinel | Dashboard Overview{% endblock %}
{% block breadcrumb %}Dashboard Overview{% endblock %}

{% block content %}
<div class="mb-10">
    <h1 class="text-4xl font-black text-white mb-2 tracking-tighter">Command Center</h1>
    <p class="text-slate-400 font-semibold tracking-wide flex items-center gap-2">
        <span class="inline-block w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
        Live Fraud Surveillance Logic & Analytics
    </p>
</div>

<!-- Filters -->
<div class="flex gap-8 mb-10 items-center bg-white/5 backdrop-blur-xl p-6 rounded-[2rem] shadow-2xl border border-white/5">
    <div class="flex items-center gap-4">
        <span class="text-xs font-black text-slate-500 uppercase tracking-widest">Target Filter</span>
        <div
            class="flex items-center justify-between border border-white/10 rounded-2xl px-5 py-3 w-72 bg-slate-900/50 cursor-pointer hover:bg-white/10 hover:border-white/20 transition-all duration-300 group">
            <span class="text-xs font-bold text-slate-300 group-hover:text-white transition-colors">Global Transaction Flow</span>
            <i data-lucide="chevron-down" class="h-4 w-4 text-slate-500 group-hover:text-blue-400 transition-colors"></i>
        </div>
    </div>

    <div class="flex items-center gap-4">
        <span class="text-xs font-black text-slate-500 uppercase tracking-widest">Time Horizon</span>
        <div
            class="flex items-center gap-4 border border-white/10 rounded-2xl px-5 py-3 bg-slate-900/50 cursor-pointer hover:bg-white/10 hover:border-white/20 transition-all duration-300 group">
            <span class="text-xs font-bold text-slate-300 group-hover:text-white transition-colors">Last 24 Hours Metrics</span>
            <i data-lucide="calendar" class="h-4 w-4 text-slate-500 group-hover:text-blue-400 transition-colors"></i>
        </div>
    </div>
</div>

<!-- Stats Grid -->
<div class="grid grid-cols-4 gap-8 mb-10">
    <!-- Card 1 -->
    <div
        class="relative group bg-slate-900/40 backdrop-blur-md p-8 rounded-[2.5rem] shadow-xl border border-white/5 overflow-hidden transition-all duration-500 hover:scale-[1.02] hover:bg-blue-600/5 hover:border-blue-500/20">
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-blue-500/10 blur-[50px] rounded-full group-hover:bg-blue-500/20 transition-colors"></div>
        <p class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-6">Aggregate Scanned</p>
        <div class="flex items-end justify-between">
            <div>
                <h2 class="text-4xl font-black text-white leading-none tracking-tighter" id="stat_total_scanned">{{ stats.total_scanned }}</h2>
                <div class="flex items-center gap-1.5 mt-3">
                    <span class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></span>
                    <p class="text-[10px] text-blue-400 font-black uppercase tracking-widest">High Vol Pulse</p>
                </div>
            </div>
            <div class="bg-blue-500/10 p-4 rounded-[1.5rem] border border-blue-500/20">
                <i data-lucide="zap" class="h-8 w-8 text-blue-400"></i>
            </div>
        </div>
    </div>

    <!-- Card 2 -->
    <div
        class="relative group bg-slate-900/40 backdrop-blur-md p-8 rounded-[2.5rem] shadow-xl border border-white/5 overflow-hidden transition-all duration-500 hover:scale-[1.02] hover:bg-indigo-600/5 hover:border-indigo-500/20">
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-500/10 blur-[50px] rounded-full group-hover:bg-indigo-500/20 transition-colors"></div>
        <p class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-6">ISO Wire Integrity</p>
        <div class="flex items-end justify-between">
            <div>
                <h2 class="text-4xl font-black text-white leading-none tracking-tighter">{{ stats.iso_messages }}</h2>
                <p class="text-[10px] text-indigo-400 font-black mt-3 uppercase tracking-widest flex items-center gap-1.5">
                    <i data-lucide="check-circle" class="h-3 w-3"></i>
                    Validated Nodes
                </p>
            </div>
            <div class="bg-indigo-500/10 p-4 rounded-[1.5rem] border border-indigo-500/20">
                <i data-lucide="file-json" class="h-8 w-8 text-indigo-400"></i>
            </div>
        </div>
    </div>

    <!-- Card 3 -->
    <div
        class="relative group bg-slate-900/40 backdrop-blur-md p-8 rounded-[2.5rem] shadow-xl border border-white/5 overflow-hidden transition-all duration-500 hover:scale-[1.02] hover:bg-rose-600/5 hover:border-rose-500/20">
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-rose-500/10 blur-[50px] rounded-full group-hover:bg-rose-500/20 transition-colors"></div>
        <p class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-6">Critical Anomalies</p>
        <div class="flex items-end justify-between">
            <div>
                <h2 class="text-4xl font-black text-rose-500 leading-none tracking-tighter">{{ stats.high_risk }}</h2>
                <div class="bg-rose-500/20 text-rose-400 text-[9px] font-black px-2 py-1 rounded-md mt-3 uppercase tracking-widest border border-rose-500/20 inline-block">
                    Immediate Action
                </div>
            </div>
            <div class="bg-rose-500/10 p-4 rounded-[1.5rem] border border-rose-500/20">
                <i data-lucide="shield-alert" class="h-8 w-8 text-rose-400"></i>
            </div>
        </div>
    </div>

    <!-- Card 4 -->
    <div
        class="relative group bg-slate-900/40 backdrop-blur-md p-8 rounded-[2.5rem] shadow-xl border border-white/5 overflow-hidden transition-all duration-500 hover:scale-[1.02] hover:bg-amber-600/5 hover:border-amber-500/20">
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-amber-500/10 blur-[50px] rounded-full group-hover:bg-amber-500/20 transition-colors"></div>
        <p class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-6">Manual Overrides</p>
        <div class="flex items-end justify-between">
            <div>
                <h2 class="text-4xl font-black text-amber-500 leading-none tracking-tighter">{{ stats.pending_review }}</h2>
                <p class="text-[10px] text-amber-400 font-black mt-3 uppercase tracking-widest flex items-center gap-1.5">
                    <i data-lucide="clock" class="h-3 w-3"></i>
                    Awaiting Agent
                </p>
            </div>
            <div class="bg-amber-500/10 p-4 rounded-[1.5rem] border border-amber-500/20">
                <i data-lucide="terminal" class="h-8 w-8 text-amber-400"></i>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Alerts Panel -->
<div class="bg-slate-900/60 backdrop-blur-2xl border border-white/5 rounded-[3rem] shadow-3xl p-10 min-h-[500px]">
    <div class="flex justify-between items-center mb-10">
        <div>
            <h3 class="text-xl font-black text-white flex items-center gap-3 tracking-tighter">
                Intercepted Security Events
                <span class="flex h-3 w-3 relative">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-rose-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-rose-500"></span>
                </span>
            </h3>
            <p class="text-[11px] text-slate-500 font-bold uppercase tracking-[0.2em] mt-2">Active Surveillance Stream</p>
        </div>
        <button onclick="triggerSimulate()"
            class="group bg-blue-600 hover:bg-blue-500 text-white px-8 py-3.5 rounded-2xl text-[11px] font-black uppercase tracking-widest transition-all shadow-xl hover:shadow-blue-500/20 border border-blue-400/20 flex items-center gap-3">
            <i data-lucide="radio" class="h-4 w-4 group-hover:animate-pulse"></i> Generate Test Load
        </button>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse" id="alertsTable">
            <thead>
                <tr class="border-b border-white/5">
                    <th class="py-5 px-6 text-[10px] font-black text-slate-500 uppercase tracking-[0.3em]">Timestamp</th>
                    <th class="py-5 px-6 text-[10px] font-black text-slate-500 uppercase tracking-[0.3em]">Threat Class</th>
                    <th class="py-5 px-6 text-[10px] font-black text-slate-500 uppercase tracking-[0.3em]">Anom. Score</th>
                    <th class="py-5 px-6 text-[10px] font-black text-slate-500 uppercase tracking-[0.3em]">Payload Context</th>
                </tr>
            </thead>
            <tbody class="text-sm divide-y divide-white/5">
                <!-- Alerts will be injected here -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function triggerSimulate() {
        fetch('/api/simulate', { method: 'POST' })
            .then(res => res.json())
            .then(data => console.log("Mock Transaction Triggered", data))
            .catch(err => console.error("Error triggering mock transaction", err));
    }

    socket.on('new_fraud_alert', function (data) {
        console.log('Received Alert:', data);

        let totalScannedElem = document.getElementById("stat_total_scanned");
        if (totalScannedElem) {
            let current = parseInt(totalScannedElem.innerText.replace(/,/g, '')) || 0;
            totalScannedElem.innerText = (current + 1).toLocaleString();
        }

        const tbody = document.querySelector('#alertsTable tbody');
        const row = document.createElement('tr');

        const isBlocked = data.status === 'BLOCKED';
        row.className = `transition-colors duration-1000 ${isBlocked ? 'bg-rose-500/20' : 'bg-blue-500/20'}`;

        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2, '0') + ":" +
            now.getMinutes().toString().padStart(2, '0') + ":" +
            now.getSeconds().toString().padStart(2, '0');

        row.innerHTML = `
            <td class="py-3 px-4 whitespace-nowrap text-slate-400 font-mono text-xs">${timeStr}</td>
            <td class="py-3 px-4 font-semibold ${isBlocked ? 'text-rose-400' : 'text-blue-400'}">
                <div class="flex items-center gap-2">
                    <i data-lucide="${isBlocked ? 'alert-triangle' : 'info'}" class="h-4 w-4"></i>
                    ${data.type}
                </div>
            </td>
            <td class="py-3 px-4">
                <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-bold ${isBlocked ? 'bg-rose-500/20 text-rose-400 border border-rose-500/20' : 'bg-blue-500/20 text-blue-400 border border-blue-500/20'}">
                    ${data.score || 0}
                </span>
            </td>
            <td class="py-3 px-4 text-slate-300">
                <span class="font-mono text-xs text-slate-500 mr-2">[${data.tx_id}]</span>
                ${data.desc}
            </td>
        `;

        tbody.insertBefore(row, tbody.firstChild);
        lucide.createIcons(); // render icons inside the new row

        setTimeout(() => { row.className = "transition-colors duration-1000 hover:bg-slate-800/50"; }, 2000);

        if (tbody.children.length > 20) { tbody.removeChild(tbody.lastChild); }
    });
</script>
{% endblock %}