{% extends "base.html" %}

{% block title %}Sentinel | Dashboard Overview{% endblock %}

{% block content %}
<!-- Symmetrical Header -->
<div class="flex flex-col items-center justify-center text-center mb-16 mt-4">
    <div
        class="inline-flex items-center gap-2 px-4 py-1.5 bg-blue-500/10 border border-blue-500/20 rounded-full text-[10px] font-black uppercase tracking-widest text-blue-400 mb-6 backdrop-blur-sm">
        <span class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></span>
        Live Analytics Engine Active
    </div>
    <h1 class="text-5xl md:text-6xl font-black text-white tracking-tighter mb-4 drop-shadow-2xl">Command Center</h1>
    <p class="text-slate-400 max-w-xl mx-auto text-sm md:text-base font-medium leading-relaxed">
        Monitor global transaction flow, identify compliance breaches, and act on critical anomalies in real-time.
    </p>
</div>

<!-- Filters / Controls Symmetrical -->
<div class="flex flex-wrap justify-center gap-6 mb-16">
    <div
        class="flex items-center gap-4 bg-slate-900/40 backdrop-blur-xl border border-white/5 rounded-2xl px-6 py-4 hover:bg-white/5 hover:border-white/10 transition-all duration-300 cursor-pointer group w-72 shadow-xl">
        <div
            class="h-10 w-10 rounded-xl bg-gradient-to-br from-blue-500/20 to-transparent flex items-center justify-center border border-blue-500/30 group-hover:scale-110 transition-transform shadow-[0_0_15px_rgba(59,130,246,0.15)]">
            <i data-lucide="globe" class="h-4 w-4 text-blue-400"></i>
        </div>
        <div class="flex flex-col w-full">
            <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-0.5">Target Filter</span>
            <div class="flex justify-between items-center w-full">
                <span class="text-sm font-bold text-slate-200">Global Flow</span>
                <i data-lucide="chevron-down"
                    class="h-3 w-3 text-slate-600 group-hover:text-blue-400 transition-colors"></i>
            </div>
        </div>
    </div>

    <div
        class="flex items-center gap-4 bg-slate-900/40 backdrop-blur-xl border border-white/5 rounded-2xl px-6 py-4 hover:bg-white/5 hover:border-white/10 transition-all duration-300 cursor-pointer group w-72 shadow-xl">
        <div
            class="h-10 w-10 rounded-xl bg-gradient-to-br from-indigo-500/20 to-transparent flex items-center justify-center border border-indigo-500/30 group-hover:scale-110 transition-transform shadow-[0_0_15px_rgba(99,102,241,0.15)]">
            <i data-lucide="calendar" class="h-4 w-4 text-indigo-400"></i>
        </div>
        <div class="flex flex-col w-full">
            <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-0.5">Time Horizon</span>
            <div class="flex justify-between items-center w-full">
                <span class="text-sm font-bold text-slate-200">Last 24 Hours</span>
                <i data-lucide="chevron-down"
                    class="h-3 w-3 text-slate-600 group-hover:text-indigo-400 transition-colors"></i>
            </div>
        </div>
    </div>
</div>

<!-- Stats Grid Symmetrical -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-16">
    <!-- Card 1 -->
    <div
        class="relative group bg-slate-900/40 backdrop-blur-xl p-8 rounded-3xl shadow-2xl border border-white/5 overflow-hidden transition-all duration-500 hover:-translate-y-1 hover:bg-blue-600/5 hover:border-blue-500/20">
        <div
            class="absolute -top-12 -right-12 w-32 h-32 bg-blue-500/10 blur-[40px] rounded-full group-hover:bg-blue-500/20 transition-colors">
        </div>
        <div class="flex flex-col h-full justify-between relative z-10">
            <div class="flex justify-between items-start mb-8">
                <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Aggregate Scanned</p>
                <div class="bg-blue-500/10 p-2.5 rounded-xl border border-blue-500/20">
                    <i data-lucide="zap" class="h-5 w-5 text-blue-400"></i>
                </div>
            </div>
            <div>
                <h2 class="text-4xl lg:text-5xl font-black text-white leading-none tracking-tighter"
                    id="stat_total_scanned">{{ stats.total_scanned }}</h2>
                <div class="flex items-center gap-1.5 mt-4">
                    <span class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></span>
                    <p class="text-[9px] text-blue-400 font-black uppercase tracking-widest">High Vol Pulse</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Card 2 -->
    <div
        class="relative group bg-slate-900/40 backdrop-blur-xl p-8 rounded-3xl shadow-2xl border border-white/5 overflow-hidden transition-all duration-500 hover:-translate-y-1 hover:bg-indigo-600/5 hover:border-indigo-500/20">
        <div
            class="absolute -top-12 -right-12 w-32 h-32 bg-indigo-500/10 blur-[40px] rounded-full group-hover:bg-indigo-500/20 transition-colors">
        </div>
        <div class="flex flex-col h-full justify-between relative z-10">
            <div class="flex justify-between items-start mb-8">
                <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">ISO Wire Integrity</p>
                <div class="bg-indigo-500/10 p-2.5 rounded-xl border border-indigo-500/20">
                    <i data-lucide="file-json" class="h-5 w-5 text-indigo-400"></i>
                </div>
            </div>
            <div>
                <h2 class="text-4xl lg:text-5xl font-black text-white leading-none tracking-tighter">{{
                    stats.iso_messages }}</h2>
                <p
                    class="text-[9px] text-indigo-400 font-black mt-4 uppercase tracking-widest flex items-center gap-1.5">
                    <i data-lucide="check-circle" class="h-3 w-3"></i> Validated Nodes
                </p>
            </div>
        </div>
    </div>

    <!-- Card 3 -->
    <div
        class="relative group bg-slate-900/40 backdrop-blur-xl p-8 rounded-3xl shadow-2xl border border-white/5 overflow-hidden transition-all duration-500 hover:-translate-y-1 hover:bg-rose-600/5 hover:border-rose-500/20">
        <div
            class="absolute -top-12 -right-12 w-32 h-32 bg-rose-500/10 blur-[40px] rounded-full group-hover:bg-rose-500/20 transition-colors">
        </div>
        <div class="flex flex-col h-full justify-between relative z-10">
            <div class="flex justify-between items-start mb-8">
                <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Critical Anomalies</p>
                <div class="bg-rose-500/10 p-2.5 rounded-xl border border-rose-500/20">
                    <i data-lucide="shield-alert" class="h-5 w-5 text-rose-400"></i>
                </div>
            </div>
            <div>
                <h2 class="text-4xl lg:text-5xl font-black text-rose-500 leading-none tracking-tighter">{{
                    stats.high_risk }}</h2>
                <div
                    class="bg-rose-500/20 text-rose-400 text-[9px] font-black px-2 py-1.5 rounded-lg mt-4 uppercase tracking-widest border border-rose-500/20 inline-block">
                    Immediate Action
                </div>
            </div>
        </div>
    </div>

    <!-- Card 4 -->
    <div
        class="relative group bg-slate-900/40 backdrop-blur-xl p-8 rounded-3xl shadow-2xl border border-white/5 overflow-hidden transition-all duration-500 hover:-translate-y-1 hover:bg-amber-600/5 hover:border-amber-500/20">
        <div
            class="absolute -top-12 -right-12 w-32 h-32 bg-amber-500/10 blur-[40px] rounded-full group-hover:bg-amber-500/20 transition-colors">
        </div>
        <div class="flex flex-col h-full justify-between relative z-10">
            <div class="flex justify-between items-start mb-8">
                <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Manual Overrides</p>
                <div class="bg-amber-500/10 p-2.5 rounded-xl border border-amber-500/20">
                    <i data-lucide="terminal" class="h-5 w-5 text-amber-400"></i>
                </div>
            </div>
            <div>
                <h2 class="text-4xl lg:text-5xl font-black text-amber-500 leading-none tracking-tighter">{{
                    stats.pending_review }}</h2>
                <p
                    class="text-[9px] text-amber-400 font-black mt-4 uppercase tracking-widest flex items-center gap-1.5">
                    <i data-lucide="clock" class="h-3 w-3"></i> Awaiting Agent
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Alerts Panel -->
<div class="bg-slate-900/60 backdrop-blur-2xl border border-white/5 rounded-3xl shadow-2xl p-8 lg:p-12 min-h-[500px]">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10">
        <div>
            <h3 class="text-2xl font-black text-white flex items-center gap-3 tracking-tighter">
                Intercepted Security Events
                <span class="flex h-3 w-3 relative">
                    <span
                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-rose-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-rose-500"></span>
                </span>
            </h3>
            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-2">Active Surveillance Stream
            </p>
        </div>
        <button onclick="triggerSimulate()"
            class="group bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all shadow-[0_0_20px_rgba(59,130,246,0.3)] hover:shadow-[0_0_30px_rgba(59,130,246,0.5)] border border-white/10 flex items-center gap-3 active:scale-95">
            <i data-lucide="radio" class="h-4 w-4 group-hover:animate-pulse"></i> Generate Test Load
        </button>
    </div>

    <div class="overflow-x-auto rounded-2xl border border-white/5 bg-black/20">
        <table class="w-full text-left border-collapse" id="alertsTable">
            <thead>
                <tr class="bg-white/[0.02]">
                    <th class="py-5 px-6 text-[9px] font-black text-slate-500 uppercase tracking-widest w-40">Timestamp
                    </th>
                    <th class="py-5 px-6 text-[9px] font-black text-slate-500 uppercase tracking-widest w-48">Threat
                        Class</th>
                    <th class="py-5 px-6 text-[9px] font-black text-slate-500 uppercase tracking-widest w-32">Risk Score
                    </th>
                    <th class="py-5 px-6 text-[9px] font-black text-slate-500 uppercase tracking-widest">Payload Context
                    </th>
                </tr>
            </thead>
            <tbody class="text-sm divide-y divide-white/5">
                <!-- Alerts will be injected here -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function triggerSimulate() {
        const btn = document.querySelector('button[onclick="triggerSimulate()"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = `<i data-lucide="loader-2" class="h-4 w-4 animate-spin"></i> Processing...`;
        lucide.createIcons();

        fetch('/api/simulate', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                console.log("Mock Transaction Triggered", data);
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    lucide.createIcons();
                }, 500);
            })
            .catch(err => {
                console.error("Error triggering mock", err);
                btn.innerHTML = originalText;
                lucide.createIcons();
            });
    }

    socket.on('new_fraud_alert', function (data) {
        let totalScannedElem = document.getElementById("stat_total_scanned");
        if (totalScannedElem) {
            let current = parseInt(totalScannedElem.innerText.replace(/,/g, '')) || 0;
            totalScannedElem.innerText = (current + 1).toLocaleString();
        }

        const tbody = document.querySelector('#alertsTable tbody');
        const row = document.createElement('tr');

        const isBlocked = data.status === 'BLOCKED';
        row.className = `transition-all duration-1000 ${isBlocked ? 'bg-rose-500/10' : 'bg-blue-500/10'}`;

        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2, '0') + ":" +
            now.getMinutes().toString().padStart(2, '0') + ":" +
            now.getSeconds().toString().padStart(2, '0');

        row.innerHTML = `
            <td class="py-4 px-6 whitespace-nowrap text-slate-400 font-mono text-xs">${timeStr}</td>
            <td class="py-4 px-6 font-semibold ${isBlocked ? 'text-rose-400' : 'text-blue-400'} text-xs">
                <div class="flex items-center gap-2">
                    <i data-lucide="${isBlocked ? 'alert-octagon' : 'info'}" class="h-4 w-4"></i>
                    ${data.type}
                </div>
            </td>
            <td class="py-4 px-6">
                <span class="inline-flex items-center px-2 py-1 rounded text-[10px] font-black uppercase tracking-widest ${isBlocked ? 'bg-rose-500/20 text-rose-400 border border-rose-500/30' : 'bg-blue-500/20 text-blue-400 border border-blue-500/30'}">
                    ${data.score || 0}
                </span>
            </td>
            <td class="py-4 px-6 text-slate-300 text-sm">
                <span class="font-mono text-[10px] text-slate-500 mr-3 px-2 py-1 bg-black/30 rounded border border-white/5">[${data.tx_id}]</span>
                ${data.desc}
            </td>
        `;

        tbody.insertBefore(row, tbody.firstChild);
        lucide.createIcons();

        setTimeout(() => { row.className = "transition-colors duration-1000 hover:bg-white/[0.02]"; }, 2000);

        if (tbody.children.length > 20) { tbody.removeChild(tbody.lastChild); }
    });
</script>
{% endblock %}